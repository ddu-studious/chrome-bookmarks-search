# v1.4.0 需求文档 - 多关键字搜索与删除功能

**版本**: v1.4.0  
**创建日期**: 2025-01-30  
**状态**: 开发中

---

## 需求背景

当前搜索功能只支持单一关键字匹配，用户在搜索包含多个特征的内容时效率较低。例如搜索「配置中心 会员」时，希望结果同时包含这两个关键字。

此外，用户在浏览搜索结果时，希望能够直接删除不需要的书签、关闭标签页或删除历史记录，提升管理效率。

---

## 需求目标

1. **多关键字 AND 搜索**：支持空格分隔的多个关键字，结果必须同时包含所有关键字
2. **右键删除能力**：在右键菜单中增加删除选项，支持删除书签、关闭标签页、删除历史记录等

---

## 功能需求

### P0 - 核心功能

#### F1: 多关键字 AND 搜索

| 属性 | 说明 |
|------|------|
| **功能描述** | 空格分隔的多个关键字使用 AND 逻辑，结果必须同时匹配所有关键字 |
| **触发方式** | 用户在搜索框输入带空格的搜索词 |
| **预期行为** | 自动将搜索词按空格分割，每个结果项必须包含所有关键字 |

**搜索语法示例：**

| 输入 | 行为 |
|------|------|
| `配置中心 会员` | 结果必须同时包含「配置中心」和「会员」 |
| `github react hooks` | 结果必须同时包含「github」、「react」、「hooks」 |
| `"配置中心" 会员` | 「配置中心」精确匹配，同时包含「会员」 |
| `site:github.com react hooks` | 限定 github.com，且包含「react」和「hooks」 |

**匹配规则：**
- 关键字在 title、url、filename 中任意位置匹配即可
- 不区分大小写
- 支持与现有高级语法（site:、type:、in:、after:、before:）组合使用

#### F2: 右键删除功能

| 属性 | 说明 |
|------|------|
| **功能描述** | 在搜索结果的右键菜单中增加删除选项 |
| **触发方式** | 用户右键点击搜索结果项 |
| **预期行为** | 根据当前 TAB 类型显示相应的删除选项 |

**各 TAB 删除行为：**

| TAB | 菜单文案 | 行为 | 需要确认 |
|-----|---------|------|---------|
| 书签 | 删除书签 | 调用 `chrome.bookmarks.remove()` | 是 |
| 标签页 | 关闭标签页 | 调用 `chrome.tabs.remove()` | 否 |
| 历史记录 | 删除此记录 | 调用 `chrome.history.deleteUrl()` | 否 |
| 下载 | 删除记录 | 调用 `chrome.downloads.erase()` | 否 |

**交互设计：**
- 删除书签前显示确认提示（不可恢复）
- 删除成功后从列表中移除该项
- 删除成功后显示简短的成功提示（可选）

---

### P1 - 增强功能

#### F3: 引号精确匹配（可选）

| 属性 | 说明 |
|------|------|
| **功能描述** | 用引号包裹的内容作为整体进行精确匹配 |
| **示例** | `"项目会议" 2024` → 精确匹配「项目会议」，同时包含「2024」 |

---

## 技术方案

### 多关键字搜索实现

修改 `js/search-parser.js`：

```javascript
// 1. 解析搜索文本，提取引号内的精确匹配词
static parseKeywords(searchText) {
  const exactMatches = [];
  const keywords = [];
  
  // 提取引号内的精确匹配
  let text = searchText.replace(/"([^"]+)"/g, (match, p1) => {
    exactMatches.push(p1);
    return '';
  });
  
  // 剩余文本按空格分割
  text.trim().split(/\s+/).filter(Boolean).forEach(kw => {
    keywords.push(kw);
  });
  
  return { exactMatches, keywords };
}

// 2. 过滤时要求所有关键字都匹配
static matchAllKeywords(item, exactMatches, keywords) {
  const searchable = [
    item.title || '',
    item.url || '',
    item.filename || ''
  ].join(' ').toLowerCase();
  
  // 检查精确匹配
  for (const exact of exactMatches) {
    if (!searchable.includes(exact.toLowerCase())) {
      return false;
    }
  }
  
  // 检查关键字
  for (const kw of keywords) {
    if (!searchable.includes(kw.toLowerCase())) {
      return false;
    }
  }
  
  return true;
}
```

### 右键删除实现

修改 `js/popup.js` 中的右键菜单处理：

```javascript
// 1. 在 popup.html 中添加删除菜单项
<div class="menu-item delete-action" data-action="delete">
  <svg>...</svg>
  <span>删除</span>
</div>

// 2. 根据当前模式设置菜单文案
function updateDeleteMenuText(mode) {
  const textMap = {
    bookmarks: '删除书签',
    tabs: '关闭标签页',
    history: '删除此记录',
    downloads: '删除记录'
  };
  deleteMenuItem.querySelector('span').textContent = textMap[mode];
}

// 3. 处理删除操作
async function handleDelete(item, mode) {
  switch (mode) {
    case 'bookmarks':
      if (confirm('确定要删除此书签吗？此操作不可恢复。')) {
        await chrome.bookmarks.remove(item.id);
      }
      break;
    case 'tabs':
      await chrome.tabs.remove(item.id);
      break;
    case 'history':
      await chrome.history.deleteUrl({ url: item.url });
      break;
    case 'downloads':
      await chrome.downloads.erase({ id: item.id });
      break;
  }
  // 刷新列表
  loadData();
}
```

---

## UI 设计

### 右键菜单新增项

```
┌─────────────────────────┐
│ 📄 在新标签页打开        │
│ 🔒 在隐私窗口打开        │
├─────────────────────────┤
│ 📋 复制链接              │
│ 📤 分享链接              │
├─────────────────────────┤
│ 🗑️ 删除书签             │  ← 新增（根据 TAB 显示不同文案）
└─────────────────────────┘
```

### 删除确认弹窗（书签）

```
┌─────────────────────────────────┐
│         删除确认                │
├─────────────────────────────────┤
│ 确定要删除此书签吗？            │
│ 此操作不可恢复。                │
├─────────────────────────────────┤
│     [取消]      [确定删除]      │
└─────────────────────────────────┘
```

---

## 测试用例

### 多关键字搜索测试

| 用例 | 输入 | 预期结果 |
|------|------|---------|
| TC1 | `github react` | 只显示同时包含 github 和 react 的结果 |
| TC2 | `配置 中心` | 只显示同时包含「配置」和「中心」的结果 |
| TC3 | `"配置中心" 会员` | 精确匹配「配置中心」，同时包含「会员」 |
| TC4 | `site:github.com react hooks` | github.com 下同时包含 react 和 hooks |
| TC5 | 单个关键字 | 行为与之前一致 |

### 右键删除测试

| 用例 | 操作 | 预期结果 |
|------|------|---------|
| TC6 | 书签页右键删除 | 显示确认弹窗，确认后删除书签 |
| TC7 | 标签页右键删除 | 直接关闭标签页，无确认 |
| TC8 | 历史页右键删除 | 直接删除记录，无确认 |
| TC9 | 下载页右键删除 | 直接删除下载记录，无确认 |
| TC10 | 删除后刷新 | 删除成功后列表自动更新 |

---

## 验收标准

- [ ] 空格分隔的多个关键字使用 AND 逻辑搜索
- [ ] 引号内的内容作为整体精确匹配
- [ ] 多关键字搜索与现有高级语法兼容
- [ ] 右键菜单根据当前 TAB 显示正确的删除文案
- [ ] 删除书签时显示确认弹窗
- [ ] 删除成功后列表自动刷新
- [ ] 删除功能不影响其他右键菜单功能

---

## 风险评估

| 风险 | 影响 | 缓解措施 |
|------|------|---------|
| 书签误删 | 用户数据丢失 | 添加确认弹窗 |
| 性能问题 | 多关键字过滤可能变慢 | 优化匹配算法 |

---

## 版本规划

- **v1.4.0**: 本需求全部功能
- **后续**: 可考虑添加撤销删除功能（利用 Chrome 同步）

---

**最后更新**: 2025-01-30

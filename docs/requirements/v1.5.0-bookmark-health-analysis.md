# v1.5.0 需求文档 - 书签健康分析

**版本**: v1.5.0  
**创建日期**: 2026-02-02  
**状态**: 待开发

---

## 需求背景

用户收藏了大量书签，但很多书签添加后从未访问过，导致书签列表臃肿、查找效率降低。Chrome 原生书签管理器缺乏使用情况分析功能，无法帮助用户识别和清理无用书签。

### Chrome 原生能力分析

**Chrome 书签管理器 (chrome://bookmarks/) 现状：**

| 功能 | 支持情况 |
|------|---------|
| 按使用频率筛选 | ❌ 不支持 |
| 显示访问次数 | ❌ 不支持 |
| 显示最后访问时间 | ❌ 不支持 |
| 识别从未使用的书签 | ❌ 不支持 |
| 检测重复书签 | ❌ 不支持 |
| 批量清理 | ❌ 不支持 |

**Chrome API 能力：**

| API | 能力 |
|-----|------|
| `chrome.bookmarks.getTree()` | 获取所有书签，包含 `dateAdded`（创建时间）、`dateLastUsed`（最后使用时间，Chrome 114+） |
| `chrome.history.getVisits(url)` | 获取指定 URL 的所有访问记录，包含访问次数、每次访问时间、访问类型 |

通过组合使用这两个 API，我们可以为每个书签建立完整的使用档案，实现 Chrome 原生不具备的书签健康分析功能。

---

## 需求目标

1. **识别未使用书签**：通过历史记录分析，找出添加后从未访问过的书签
2. **书签使用分类**：将书签按使用情况分为「未使用」「很少使用」「休眠」「活跃」四类
3. **便捷的筛选与管理**：提供筛选器 UI，支持快速筛选各类书签并进行批量管理

---

## 功能需求

### P0 - 核心功能

#### F1: 书签使用情况分类

| 属性 | 说明 |
|------|------|
| **功能描述** | 根据历史访问记录，将书签分为四种使用状态 |
| **数据来源** | `chrome.history.getVisits()` 返回的访问记录 |
| **分类标准** | 见下表 |

**书签分类标准：**

| 分类 | 英文标识 | 判断条件 | 标签颜色 | 说明 |
|------|---------|---------|---------|------|
| 未使用 | `never_used` | `visitCount === 0` | 🔴 红色 | 添加后从未访问过 |
| 很少使用 | `rarely_used` | `visitCount <= 2` | 🟠 橙色 | 访问次数极少 |
| 休眠 | `dormant` | 最后访问 > 180天前 | ⚪ 灰色 | 长期未访问 |
| 活跃 | `active` | 其他情况 | 无标签 | 正常使用中 |

**注意事项：**
- 分类按优先级从上到下判断，即 `visitCount === 0` 优先于其他条件
- `visitCount` 来自 `chrome.history.getVisits()` 返回的数组长度
- 最后访问时间来自访问记录数组的最新一条

#### F2: 书签筛选器 UI

| 属性 | 说明 |
|------|------|
| **功能描述** | 在书签模式下显示筛选器，可按使用状态筛选书签 |
| **显示位置** | 排序按钮栏下方 |
| **显示条件** | 仅在书签模式下显示，其他模式隐藏 |

**筛选器设计：**

```
排序：[智能] [时间] [频率]
筛选：[全部] [未使用 (N)] [很少使用 (N)] [休眠 (N)]
```

**交互行为：**

| 操作 | 行为 |
|------|------|
| 点击筛选按钮 | 显示对应类别的书签 |
| 数字实时更新 | 加载书签后统计各类别数量 |
| 与搜索组合 | 筛选后仍可使用搜索框进一步过滤 |
| 与排序组合 | 筛选后仍可切换排序方式 |

#### F3: 结果项状态标签

| 属性 | 说明 |
|------|------|
| **功能描述** | 在搜索结果项上显示使用状态标签 |
| **显示位置** | 结果项右上角或 meta 信息区域 |
| **显示条件** | 仅对非活跃书签显示标签 |

**标签样式：**

| 状态 | 标签文字 | 样式 |
|------|---------|------|
| 未使用 | 从未访问 | 红色背景，白色文字 |
| 很少使用 | 访问较少 | 橙色背景，白色文字 |
| 休眠 | 长期未访问 | 灰色背景，白色文字 |

---

### P1 - 增强功能

#### F4: 书签添加时间显示

| 属性 | 说明 |
|------|------|
| **功能描述** | 在未使用/休眠书签上显示添加时间 |
| **目的** | 帮助用户判断书签是否过时 |
| **格式** | "添加于 2024-01-15" 或 "添加于 2年前" |

#### F5: 批量删除未使用书签

| 属性 | 说明 |
|------|------|
| **功能描述** | 在筛选「未使用」书签后，支持全选并批量删除 |
| **触发方式** | 使用现有的多选功能（Ctrl/Cmd + Click） |
| **确认机制** | 批量删除需要二次确认，显示将删除的数量 |

---

### P2 - 未来规划

以下功能在后续版本中实现：

#### F6: 重复书签检测（v1.6.0）

- 检测相同 URL 的书签
- 显示重复数量
- 支持一键去重（保留最早添加的）

#### F7: 失效链接检测（v1.7.0）

- 后台异步检测 404 链接
- 标记失效书签
- 支持批量清理

---

## 技术方案

### 1. 书签分类算法

在 `js/popup.js` 中新增分类函数：

```javascript
// 书签使用状态常量
const BOOKMARK_STATUS = {
  NEVER_USED: 'never_used',
  RARELY_USED: 'rarely_used', 
  DORMANT: 'dormant',
  ACTIVE: 'active'
};

// 分类阈值
const THRESHOLDS = {
  RARELY_USED_MAX: 2,        // 访问次数 <= 2 视为很少使用
  DORMANT_DAYS: 180          // 180天未访问视为休眠
};

// 书签分类函数
function categorizeBookmark(bookmark) {
  const { visitCount, lastVisit, dateAdded } = bookmark;
  const now = Date.now();
  
  // 从未使用
  if (!visitCount || visitCount === 0) {
    return BOOKMARK_STATUS.NEVER_USED;
  }
  
  // 很少使用
  if (visitCount <= THRESHOLDS.RARELY_USED_MAX) {
    return BOOKMARK_STATUS.RARELY_USED;
  }
  
  // 休眠（超过180天未访问）
  if (lastVisit) {
    const daysSinceLastVisit = (now - lastVisit) / (1000 * 60 * 60 * 24);
    if (daysSinceLastVisit > THRESHOLDS.DORMANT_DAYS) {
      return BOOKMARK_STATUS.DORMANT;
    }
  }
  
  // 活跃
  return BOOKMARK_STATUS.ACTIVE;
}
```

### 2. 修改 loadBookmarks 函数

```javascript
async function loadBookmarks() {
  const bookmarkTree = await chrome.bookmarks.getTree();
  allBookmarks = [];
  
  function traverseBookmarks(node) {
    if (node.url) {
      allBookmarks.push(node);
    }
    if (node.children) {
      node.children.forEach(traverseBookmarks);
    }
  }
  
  bookmarkTree.forEach(traverseBookmarks);
  
  // 获取访问统计并分类
  const bookmarksWithStats = await Promise.all(
    allBookmarks.map(async bookmark => {
      const stats = await getUrlStats(bookmark.url);
      const bookmarkData = {
        ...bookmark,
        visitCount: stats.count,
        lastVisit: stats.lastVisit
      };
      bookmarkData.usageStatus = categorizeBookmark(bookmarkData);
      return bookmarkData;
    })
  );
  
  allBookmarks = bookmarksWithStats;
  
  // 更新筛选器统计
  updateFilterCounts();
  
  // 显示结果
  displayResults(filterByUsageStatus(allBookmarks, currentFilter));
}
```

### 3. 筛选器实现

```javascript
let currentFilter = 'all'; // 当前筛选状态

// 按使用状态筛选
function filterByUsageStatus(bookmarks, filter) {
  if (filter === 'all') return bookmarks;
  return bookmarks.filter(b => b.usageStatus === filter);
}

// 更新筛选器计数
function updateFilterCounts() {
  const counts = {
    never_used: 0,
    rarely_used: 0,
    dormant: 0
  };
  
  allBookmarks.forEach(b => {
    if (counts.hasOwnProperty(b.usageStatus)) {
      counts[b.usageStatus]++;
    }
  });
  
  // 更新 UI
  document.querySelector('[data-filter="never_used"] .count').textContent = counts.never_used;
  document.querySelector('[data-filter="rarely_used"] .count').textContent = counts.rarely_used;
  document.querySelector('[data-filter="dormant"] .count').textContent = counts.dormant;
}
```

### 4. HTML 结构

在 `popup.html` 中添加筛选器：

```html
<!-- 书签筛选器（仅在书签模式下显示） -->
<div class="bookmark-filters" id="bookmarkFilters">
  <span class="filter-label">筛选：</span>
  <button class="filter-btn active" data-filter="all">全部</button>
  <button class="filter-btn" data-filter="never_used">
    未使用 <span class="count">0</span>
  </button>
  <button class="filter-btn" data-filter="rarely_used">
    很少使用 <span class="count">0</span>
  </button>
  <button class="filter-btn" data-filter="dormant">
    休眠 <span class="count">0</span>
  </button>
</div>
```

### 5. CSS 样式

```css
/* 筛选器栏 */
.bookmark-filters {
  display: none;
  align-items: center;
  gap: 8px;
  padding: 8px 12px;
  background: var(--color-bg-secondary);
  border-bottom: 1px solid var(--color-border);
}

.bookmark-filters.show {
  display: flex;
}

.filter-btn {
  padding: 4px 10px;
  border: 1px solid var(--color-border);
  border-radius: 12px;
  background: transparent;
  color: var(--color-text-secondary);
  font-size: 12px;
  cursor: pointer;
  transition: all 0.2s;
}

.filter-btn:hover {
  border-color: var(--color-primary);
  color: var(--color-primary);
}

.filter-btn.active {
  background: var(--color-primary);
  border-color: var(--color-primary);
  color: white;
}

.filter-btn .count {
  margin-left: 4px;
  opacity: 0.8;
}

/* 状态标签 */
.status-tag {
  display: inline-block;
  padding: 2px 6px;
  border-radius: 4px;
  font-size: 10px;
  font-weight: 500;
}

.status-tag.never-used {
  background: #f44336;
  color: white;
}

.status-tag.rarely-used {
  background: #ff9800;
  color: white;
}

.status-tag.dormant {
  background: #9e9e9e;
  color: white;
}
```

---

## UI 设计

### 整体布局

```
┌─────────────────────────────────────────────────┐
│ [📚 书签] [📑 标签页] [📜 历史] [📥 下载]          │
├─────────────────────────────────────────────────┤
│ 🔍 搜索书签...                              [?] │
├─────────────────────────────────────────────────┤
│ 排序：[智能] [时间] [频率]                       │
│ 筛选：[全部] [未使用 (23)] [很少使用 (45)] [休眠 (12)] │
├─────────────────────────────────────────────────┤
│                                                 │
│  🔖 从未访问过的书签标题                [从未访问] │
│     https://example.com                         │
│     添加于 2024-01-15                            │
│                                                 │
│  🔖 访问较少的书签标题                  [访问较少] │
│     https://example2.com                        │
│     2次访问 · 3个月前                            │
│                                                 │
└─────────────────────────────────────────────────┘
```

### 筛选器状态

```
默认状态：
[全部] [未使用 (23)] [很少使用 (45)] [休眠 (12)]
  ↑ 蓝色高亮

点击「未使用」后：
[全部] [未使用 (23)] [很少使用 (45)] [休眠 (12)]
           ↑ 红色高亮，显示所有未使用书签
```

---

## 测试用例

### 书签分类测试

| 用例 | 条件 | 预期分类 |
|------|------|---------|
| TC1 | 访问次数 = 0 | 未使用 |
| TC2 | 访问次数 = 1 | 很少使用 |
| TC3 | 访问次数 = 2 | 很少使用 |
| TC4 | 访问次数 = 3，最后访问在30天内 | 活跃 |
| TC5 | 访问次数 = 10，最后访问在200天前 | 休眠 |
| TC6 | 访问次数 = 5，最后访问在179天前 | 活跃 |

### 筛选器测试

| 用例 | 操作 | 预期结果 |
|------|------|---------|
| TC7 | 点击「未使用」筛选 | 只显示 visitCount=0 的书签 |
| TC8 | 筛选后搜索 | 在已筛选结果中搜索 |
| TC9 | 切换到其他模式 | 筛选器隐藏 |
| TC10 | 切回书签模式 | 筛选器显示，保持之前的筛选状态 |
| TC11 | 删除书签后 | 计数自动更新 |

### 批量操作测试

| 用例 | 操作 | 预期结果 |
|------|------|---------|
| TC12 | 筛选「未使用」后多选删除 | 成功删除，列表更新 |
| TC13 | 批量删除确认 | 显示确认弹窗，包含数量 |

---

## 验收标准

- [ ] 书签正确分类为四种状态
- [ ] 筛选器仅在书签模式下显示
- [ ] 筛选器显示各状态的数量
- [ ] 点击筛选器正确过滤书签
- [ ] 筛选后可继续搜索
- [ ] 筛选后可切换排序
- [ ] 结果项显示状态标签
- [ ] 未使用书签显示添加时间
- [ ] 支持多选和批量删除
- [ ] 切换模式后筛选器正确显隐

---

## 性能考虑

### 现有优化

当前代码在 `loadBookmarks()` 中已经为每个书签获取访问统计：

```javascript
const statsPromises = allBookmarks.map(async bookmark => {
  const stats = await getUrlStats(bookmark.url);
  return { ...bookmark, visitCount: stats.count, lastVisit: stats.lastVisit };
});
```

### 新增开销

- 分类计算：O(n) 遍历，开销可忽略
- 筛选器计数：O(n) 遍历，开销可忽略
- UI 更新：仅更新 DOM 元素的数字，开销极小

**结论**：新功能复用现有数据，不会增加 API 调用次数，性能影响可忽略。

---

## 风险评估

| 风险 | 影响 | 概率 | 缓解措施 |
|------|------|------|---------|
| 误删有用书签 | 数据丢失 | 中 | 删除前确认、显示书签标题 |
| 历史记录不完整 | 分类不准 | 低 | 说明仅基于当前浏览器历史 |
| 大量书签性能问题 | 加载慢 | 低 | 现有代码已做并行优化 |

---

## 版本规划

| 版本 | 功能 | 状态 |
|------|------|------|
| v1.5.0 | 书签健康分析（本需求） | 待开发 |
| v1.6.0 | 重复书签检测 | 规划中 |
| v1.7.0 | 失效链接检测 | 规划中 |

---

## 参考资料

- [Chrome Bookmarks API](https://developer.chrome.com/docs/extensions/reference/bookmarks/)
- [Chrome History API](https://developer.chrome.com/docs/extensions/reference/history/)
- [BookmarkTreeNode.dateLastUsed (Chrome 114+)](https://developer.chrome.com/docs/extensions/reference/bookmarks/#type-BookmarkTreeNode)

---

**最后更新**: 2026-02-02
